# =============================================================================
# Raven SaaS - Production Docker Compose
# =============================================================================
# Usage:
#   docker compose up -d
#   docker compose exec web python manage.py migrate
#   docker compose exec web python manage.py createsuperuser
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL 16
  # ---------------------------------------------------------------------------
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: ${DB_NAME:-raven_db}
      POSTGRES_USER: ${DB_USER:-raven}
      POSTGRES_PASSWORD: ${DB_PASSWORD:?Set DB_PASSWORD in .env}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-raven} -d ${DB_NAME:-raven_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "127.0.0.1:5432:5432"

  # ---------------------------------------------------------------------------
  # Redis 7 (channel layer + caching)
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "127.0.0.1:6379:6379"

  # ---------------------------------------------------------------------------
  # Django (Gunicorn - HTTP)
  # ---------------------------------------------------------------------------
  web:
    build: .
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - media_data:/app/media
      - static_data:/app/staticfiles
    env_file:
      - .env
    environment:
      DB_ENGINE: django.db.backends.postgresql
      DB_HOST: db
      DB_PORT: "5432"
      REDIS_URL: redis://redis:6379
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health/"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3

  # ---------------------------------------------------------------------------
  # Daphne (WebSocket / ASGI)
  # ---------------------------------------------------------------------------
  websocket:
    build: .
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: daphne -b 0.0.0.0 -p 8001 raven.asgi:application
    env_file:
      - .env
    environment:
      DB_ENGINE: django.db.backends.postgresql
      DB_HOST: db
      DB_PORT: "5432"
      REDIS_URL: redis://redis:6379
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/v1/health/"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

  # ---------------------------------------------------------------------------
  # Nginx (reverse proxy + static/media files)
  # ---------------------------------------------------------------------------
  nginx:
    image: nginx:1.27-alpine
    restart: unless-stopped
    depends_on:
      web:
        condition: service_healthy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - static_data:/app/staticfiles:ro
      - media_data:/app/media:ro
      - ./frontend/dist:/app/frontend/dist:ro
      # Uncomment for SSL with Let's Encrypt:
      # - ./nginx/certs:/etc/nginx/certs:ro
      # - ./nginx/certbot:/var/www/certbot:ro
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/api/v1/health/"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
  redis_data:
  media_data:
  static_data:
